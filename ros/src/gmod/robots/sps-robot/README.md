# Тестовая модель робота

Пример простейшего тестового мобильного робота с дифференциальным приводом и сенсорами --- дальномером и контактным бампером. Модель включает в себя два пакета ROS --- test_robot_description с описанием робота и test_robot_config с параметрами его модели и скриптом запуска. Для упрощения ознакомления с моделью все структурные компоненты робота описаны в одном файле test_robot_description/urdf/test_robot.urdf.xacro, все параметры запуска полной модели --- в одном файле test_robot_config/launch/test_robot_gazebo.launch.

## Запуск модели

Команда полного запуска модели в среде моделирования Gazebo:

roslaunch test_robot_config test_robot_gazebo.launch

Команда просмотра модели робота в rviz (без использования Gazebo, только для проверки кинематической схемы):

roslaunch test_robot_description test_urdf.launch

## Работа с моделью

A. Отправка команд движения

Робот способен двигаться под управлением команд, отправляемых в топик /mobile_base_controller/cmd_vel в формате geometry_msgs/Twist. Команды должны отправляться периодически, потому что при их отсутствии в течение некоторого малого времени (порядка 1 с) робот в целях безопасности останавливается. Пример команды:

rostopic pub /mobile_base_controller/cmd_vel geometry_msgs/Twist "{linear: {x: 0.1, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: 0.2" -r 10

Данная команда заставит робота двигаться со скоростью 0.1 м/с вперёд (т.е. вдоль оси X), поворачиваясь при этом на 0.2 рад/с влево (т.е. вокруг оси Z).

Б. Отправка команды поворота дальномера

Для управления ориентацией дальномера следует отправить в топик /rf_state_controller/command команду формата std_msgs/Float64, содержащую дробное число --- угол в радианах от нейтрального положения в пределах -pi/2, pi/2. Например, для поворота на 0.5 рад вправо команда будет выглядеть так:

rostopic pub /rf_state_controller/command std_msgs/Float64 "data: -0.5" -1

В. Чтение показаний дальномера

Показания дальномера доступны из топика /rf_link/rf_data стандартного типа sensor_msgs/Range; при использовании нескольких дальномеров можно различать их по значениям header.frame_id, которые должны быть равны названиям link'а снявшего показания дальномера.

Г. Чтение данных о состоянии бампера

Данные о состоянии контактного бампера постоянно отправляются специальным узлом модели в топик /bumper_handler/has_contact типа std_msgs/Bool. Значение False означает отсутствие касания бампера к объектам, значение True --- наличие касания. Из-за особенностей моделирования физики столкновений в Gazebo при постоянном контакте бампера с посторонним предметом будет происходить дребезг значения, т.е. быстрое изменение значений True и False, исчезающее при потере контакта. Для борьбы с дребезгом следует дополнительно обработать сигнал в приёмнике. Пример команды чтения данных о состоянии бампера:

rostopic echo /bumper_handler/has_contact 

## Внутреннее устройство модели

Модель робота описана в файле test_robot_description/urdf/test_robot.urdf.xacro; основные компоненты, кроме средств моделирования бампера, находятся там.

А. Поворотный дальномер

Дальномер реализован в виде единого макроса xacro:rf с параметрами:
--- link --- строка; название части робота, с которой будет связан дальномер; эти названия не должны совпадать ни у разных дальномеров, ни у дальномера и прочих компонентов робота;
--- dx,dy,dz --- дробные числа; положение центра дальномера относительно body_link;
--- Yaw --- поворот дальномера по вертикальной оси относительно переднего направления робота.

Б. ArUco-маркер

Маркер реализован в виде текстуры для куба. Вставка куба в модель выполняется макросом  xacro:aruco_cube с параметрами:
--- material_name --- название материала-текстуры Gazebo (метод его определения описан ниже);
--- dx,dy,dz --- дробные числа; положение центра куба относительно body_link;
--- Yaw --- поворот куба по вертикальной оси относительно переднего направления робота.

Для обеспечения работы текстуры с Gazebo потребовалось разместить её описание в директориях следующей структуры:

media
--materials
----scripts
------файл описания материала-маркера example.material
----textures
------изображение маркера aruco_example.png
Корневой для этой структуры является директория пакета test_robot_description.

В файле example.material материал маркера описан в виде, требуемом средой Gazebo:

material aruco_example{  // название материала
       technique  // метод формирования текстуры
       { 
         pass  // первый (и единственный) проход
         { 
           texture_unit  // описание текстурной единицы
           { 
             texture ../textures/aruco_example.png  // файл с изображением текстуры
             scale 1 1   // масштаб текстуры
             } 
         }
       } 
     }

Также для работы текстур в Gazebo потребовалось прописать путь к корневой директории текстур в переменной среды GAZEBO_RESOURCE_PATH; выполнено это в начале launch-файла командой
<env name="GAZEBO_RESOURCE_PATH" value="$(find test_robot_description):$(optenv GAZEBO_RESOURCE_PATH)"/>

Чтобы сделать материал маркера доступным для показа URDF-модели в RViz, понадобилось создать его способом, применяемым в URDF:
<material name="${material_name}">
  <texture filename="package://test_robot_description/media/materials/textures/${material_name}.png"/>
</material>
, т.е. указать полный путь к текстуре. Для работы Gazebo с материалом этого не требуется; достаточно указать имя материала из файла media/materials/scripts/example.material "aruco_example" внутри блока объявления материала для среды Gazebo:
<gazebo reference="aruco_marker_link">
  <material> aruco_example </material> 
</gazebo>

B. Контактный бампер

Из-за проблем в работе стандартных средств описания контактных сенсоров пришлось реализовывать отдельный узел, который проверяет текущий список касаний, доступный через программный интерфейс среды Gazebo. Этот узел называется contact_handler_node и находится в пакете test_robot_description. Параметры узла:
--- timer_freq (float, по умолчанию 10.) --- частота отсылки сообщений о состоянии бампера;
--- bumper_gazebo_link (string) --- внутреннее название collision-части бампера в среде Gazebo. Так как это название формируется в процессе преобразования URDF-описания робота в SDF-представление Gazebo, при изменениях URDF-модели оно может измениться, что необходимо учитывать при тестировании.
--- setup_output (bool, по умолчанию false) --- включение вывода на консоль данных обо всех обнаруженных касаниях в формате "часть1 - часть2". Можно использовать значение true для поиска внутреннего названия collision-части, которую следует прописать в bumper_gazebo_link; в других случаях желательно держать этот параметр в состоянии false.

