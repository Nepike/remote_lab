/**
  * \file tmuregisters.ino
  * Progect:
  *  Проект YARP/TMU
  *
  *  Chip Mega 2560
  *  \author Robofob
  *  \version 4.3.5
  *  \date 10.04.2014
  *  \date Last Change: 13.08.2020
 */

/**
 * Регистры ОЗУ
 */
byte REG[NREG_RAM] = {
 IMVERSION,  //  0: REG_VERSION:    Версия
         5,  //  1: REG_ANG_STEP:   ANG_STEP Шаг угла поворота
         4,  //  2: REG_STOP_SPEED: StopSpeed Скорость останова (коррекционное значение)
        50,  //  3: REG_SPEED:      Speed Текущая скорость
         1,  //  4: REG_LOC_ENABLE: Разрешение поворота локатора
         1,  //  5: REG_ACK:        Флаг режима подтверждения
         0,  //  6: REG_USR:
             // Здесь хранятся не тики энкодеров, а пройденное расстояние в см.
         0,  //  7: REG_D1:         GlobalEncoderLeftCnt -> sm
         0,  //  8: REG_D2:         GlobalEncoderRightCnt -> sm
         0,  //  9: REG_STATUS:     Регистр статуса

       // Регистры энкодеров 16 разрядов, разделенные на 2 байта D0 и D1
         0,  // 10 REG_ENC_LEFT_D0:  GlobalEncoderLeftCnt
         0,  // 11 REG_ENC_LEFT_D1:
         0,  // 12 REG_ENC_RIGHT_D0: GlobalEncoderRightCnt
         0,  // 13 REG_ENC_RIGHT_D1:
         0   // 14 REG_CURR_ANG: Текущий угол поворота локатора
};

/**
 * Регистры ПЗУ
 */
byte REG_EEP[NREG_EEP] = {
  1,  //  0: EEP_ID: ID робота
  0,  //  1: EEP_TM_INTERRUPT: Период прерываний таймера, мс
  0,  //  2: EEP_MINU: Минимальное значение управления minU (0...255)
  0,  //  3: EEP_MAXU: Максимальное значение управления maxU (0...255)
  0,  //  4: EEP_MINSPEED: minSpeed - Скорость трогания (0..100) 
  0,  //  5: EEP_MAXSPEED: maxSpeed - Определяется процедурой DefineMaxSpeed(pidlib::maxU) (0..100)
  0,  //  6: EEP_CHECK_U: Проверяемое напряжения питания

  0,  //  7: EEP_USS_DIST:   Дистанция срабатывания УЗД бамперов, см
  1,  //  8: EEP_BUMP_DIST:  Дистанция срабатывания бамперов типа Sharp
  
 50,  //  9: EEP_KDB_MOV: Коэффициент для скорости движения вперед при отладке, % (0..100)
 25,  // 10: EEP_KDB_ROT: Коэффициент для скорости разворота при отладке, % (0..100)

  // Геометрия робота. Диаметр колеса, мм.
  0,  //  11: EEP_GMT_RWD_LO:
  0,  //  12: EEP_GMT_RWD_HI

  // Геометрия робота. Количество импульсов энкодеров на 1 оборот колеса
  // (т.к. мы регистрируем изменения сигнала, а не сам сигнал, то будем писать в 2 раза больше)
  0,  //  13: EEP_GMT_RECNT_LO
  0,  //  14: EEP_GMT_RECNT_HI

  // Геометрия робота. Расстояние между колесами, мм.
  0,  //  15: EEP_GMT_RLW_LO
  0,  //  16: EEP_GMT_RLW_HI  
  
  // ПИД-регулятор
  0,  //  17: EEP_PID_KP: Пропорциональное звено, %, (0..100)
  0,  //  18: EEP_PID_KI: Интегрирующее звено, %, (0..100)
  0,  //  19: EEP_PID_KD: Дифференцирующее звено, %, (0..100)

  0x01, // 20: EEP_SENS_ENABLE: Определение номенклатуры датчиков: 0x01 - разрешить Sharp, 0x02 - разрешить УЗД
  0x03, // 21: EEP_REFLEX: Регистр рефлексов: 0x01 - рефлекс питания, 0x02 - рефлекс препятствия
  250,  // 22: EEP_PWMSPEED:   CSPEED - скорость движения без ПИД-управления (базовая скорость движения)
  15    // 23: EEP_TM_STOP: Время, которое робот отрабатывает последнюю команду после потери связи с ВУУ (в мс, значение домножается на 100)
        // Остановка, если робот не получает никаких команд в течение децисекунд, указанных в регистре.
        // Если EEP_TM_STOP = 0, то опция отключена
};

//
// Полезные макросы
//
#define REFL_POWER (REG_EEP[EEP_REFLEX] & 0x01)
#define REFL_OBST  (REG_EEP[EEP_REFLEX] & 0x02)

#define SENS_SHARP_ENABLE (REG_EEP[EEP_SENS_ENABLE] & 0x01) // Разрешена ли работа с Sharp
#define SENS_US_ENABLE    (REG_EEP[EEP_SENS_ENABLE] & 0x02) // Разрешена ли работа с УЗД
